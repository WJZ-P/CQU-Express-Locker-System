# 面向对象系统设计说明书

## 1. 引言
本文档基于面向对象设计（OOD）原则，对系统进行详细设计，包括类图设计和交互图设计。

## 2. 类图设计 (Class Diagram)

### 2.1 核心实体类 (Entity Classes)
系统主要实体类如下：
-   **User**：用户基类，包含 `userId`, `phone`, `password`。
-   **Courier** (extends User)：快递员，增加 `company`, `employeeId`。
-   **Member** (extends User)：普通用户，增加 `balance`。
-   **Locker**：快递柜终端，包含 `lockerId`, `address`, `ipAddress`, `List<Box> boxes`。
-   **Box**：格口，包含 `boxId`, `size` (S/M/L), `status` (FREE/USED/FAULT), `doorState`, `sensorState`。
-   **Order**：订单，包含 `orderId`, `trackingNum`, `pickupCode`, `status`, `createTime`。

### 2.2 控制类 (Control Classes)
-   **AuthController**：处理登录注册。
-   **LockerController**：处理柜体查询、开锁请求。
-   **OrderController**：处理订单创建、状态更新。
-   **HardwareHandler**：处理与硬件模拟器的WebSocket连接。

### 2.3 关系描述
-   `Locker` 包含多个 `Box` (1:N)。
-   `Courier` 创建多个 `Order` (1:N)。
-   `Order` 关联一个 `Box` (1:1)。
-   `Member` 关联多个 `Order` (1:N, 作为收件人或寄件人)。

## 3. 顺序图设计 (Sequence Diagram)

### 3.1 快递员投递时序图
```mermaid
sequenceDiagram
    participant Courier as 快递员
    participant App as 快递员App
    participant API as 后端API
    participant DB as 数据库
    participant HW as 硬件模拟器

    Courier->>App: 扫描柜体二维码
    App->>API: GET /lockers/{id}/boxes
    API->>DB: 查询可用格口
    DB-->>API: 返回格口列表
    API-->>App: 显示可用格口(大/中/小)
    
    Courier->>App: 选择中号格口 & 输入单号
    App->>API: POST /orders/deposit
    API->>DB: 创建订单(Pending)
    API->>HW: 发送开门指令(BoxID)
    HW-->>Courier: 弹开柜门
    
    Courier->>HW: 放入快件并关门
    HW->>API: 上报状态(Closed, HasObject)
    API->>DB: 更新订单状态(Deposited)
    API->>DB: 生成取件码
    API-->>Courier: 投递成功通知
```

### 3.2 用户取件时序图
```mermaid
sequenceDiagram
    participant User as 用户
    participant Screen as 柜体屏幕
    participant API as 后端API
    participant DB as 数据库
    participant HW as 硬件模拟器

    User->>Screen: 点击“取件”
    Screen-->>User: 显示键盘
    User->>Screen: 输入取件码 "123456"
    Screen->>API: POST /orders/pickup (code="123456")
    
    API->>DB: 验证取件码
    alt 验证通过
        DB-->>API: 返回订单信息 & BoxID
        API->>HW: 发送开门指令(BoxID)
        HW-->>User: 弹开柜门
        User->>HW: 取走快件并关门
        HW->>API: 上报状态(Closed, Empty)
        API->>DB: 更新订单(Finished)
        API-->>Screen: 显示“取件成功”
    else 验证失败
        DB-->>API: 无效码
        API-->>Screen: 显示“取件码错误”
    end
```

## 4. 状态图设计 (State Chart Diagram)

### 4.1 订单状态机
-   **Created**: 订单创建，等待放入。
-   **Deposited**: 物品已放入，等待取件。
-   **Finished**: 用户已取件，订单结束。
-   **Timeout**: 超过24小时未取，超时状态。
-   **Canceled**: 投递取消（如开门后未放入）。

### 4.2 格口状态机
-   **Free**: 空闲，可分配。
-   **Locked**: 已分配但未放入（锁定中）。
-   **Used**: 已存物。
-   **Fault**: 故障（传感器异常或门锁损坏）。

## 5. 设计模式应用
-   **工厂模式 (Factory)**：用于创建不同类型的订单（投递单、寄件单、寄存单）。
-   **观察者模式 (Observer)**：硬件状态变更时通知后端服务。
-   **策略模式 (Strategy)**：不同用户的计费策略（普通用户、会员）。
